<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>11. Best practices &mdash; Charliecloud 0.35 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
    <link rel="shortcut icon" href="_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="12. Contributor’s guide" href="dev.html" />
    <link rel="prev" title="10. Frequently asked questions (FAQ)" href="faq.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> Charliecloud
            <img src="_static/logo-sidebar.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.35
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">1. Installing</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">2. Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="ch-checkns.html">3. <code class="code docutils literal notranslate"><span class="pre">ch-checkns</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="ch-convert.html">4. <code class="code docutils literal notranslate"><span class="pre">ch-convert</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="ch-fromhost.html">5. <code class="code docutils literal notranslate"><span class="pre">ch-fromhost</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="ch-image.html">6. <code class="code docutils literal notranslate"><span class="pre">ch-image</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="ch-run.html">7. <code class="code docutils literal notranslate"><span class="pre">ch-run</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="ch-run-oci.html">8. <code class="code docutils literal notranslate"><span class="pre">ch-run-oci</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="ch-test.html">9. <code class="code docutils literal notranslate"><span class="pre">ch-test</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">10. Frequently asked questions (FAQ)</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">11. Best practices</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#other-best-practices-information">11.1. Other best practices information</a></li>
<li class="toctree-l2"><a class="reference internal" href="#filesystems">11.2. Filesystems</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#metadata-traffic">11.2.1. Metadata traffic</a></li>
<li class="toctree-l3"><a class="reference internal" href="#file-copy-performance">11.2.2. File copy performance</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#installing-your-own-software">11.3. Installing your own software</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#third-party-software-via-package-manager">11.3.1. Third-party software via package manager</a></li>
<li class="toctree-l3"><a class="reference internal" href="#third-party-software-compiled-from-source">11.3.2. Third-party software compiled from source</a></li>
<li class="toctree-l3"><a class="reference internal" href="#your-software-stored-in-the-image">11.3.3. Your software stored in the image</a></li>
<li class="toctree-l3"><a class="reference internal" href="#your-software-stored-on-the-host">11.3.4. Your software stored on the host</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="dev.html">12. Contributor’s guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Charliecloud</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li><span class="section-number">11. </span>Best practices</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="best-practices">
<h1><span class="section-number">11. </span>Best practices<a class="headerlink" href="#best-practices" title="Permalink to this headline">¶</a></h1>
<section id="other-best-practices-information">
<h2><span class="section-number">11.1. </span>Other best practices information<a class="headerlink" href="#other-best-practices-information" title="Permalink to this headline">¶</a></h2>
<p>This isn’t the last word. Also consider:</p>
<ul class="simple">
<li><p>Many of Docker’s <a class="reference external" href="https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices">Best practices for writing Dockerfiles</a>
apply to Charliecloud images as well.</p></li>
<li><p>“<a class="reference external" href="https://f1000research.com/articles/7-742/v2">Recommendations for the packaging and containerizing of bioinformatics
software</a>”, Gruening et al.
2019, is a thoughtful editorial with eleven specific containerization
recommendations for scientific software.</p></li>
<li><p>“<a class="reference external" href="https://nvlpubs.nist.gov/nistpubs/specialpublications/nist.sp.800-190.pdf">Application container security guide</a>”,
NIST Special Publication 800-190; Souppaya, Morello, and Scarfone 2017.</p></li>
</ul>
</section>
<section id="filesystems">
<h2><span class="section-number">11.2. </span>Filesystems<a class="headerlink" href="#filesystems" title="Permalink to this headline">¶</a></h2>
<p>There are two performance gotchas to be aware of for Charliecloud.</p>
<section id="metadata-traffic">
<h3><span class="section-number">11.2.1. </span>Metadata traffic<a class="headerlink" href="#metadata-traffic" title="Permalink to this headline">¶</a></h3>
<p>Directory-format container images and the Charliecloud storage directory often
contain, and thus Charliecloud must manipulate, a very large number of files.
For example, after running the test suite, the storage directory contains
almost 140,000 files. That is, metadata traffic can be quite high.</p>
<p>Such images and the storage directory should be stored on a filesystem with
reasonable metadata performance. Notably, this <em>excludes</em> Lustre, which is
commonly used for scratch filesystems in HPC; i.e., don’t store these things
on Lustre. NFS is usually fine, though in general it performs worse than a
local filesystem.</p>
<p>In contrast, SquashFS images, which encapsulate the image into a single file
that is mounted using FUSE at runtime, insulate the filesystem from this
metadata traffic. Images in this format are suitable for any filesystem,
including Lustre.</p>
</section>
<section id="file-copy-performance">
<span id="best-practices-file-copy"></span><h3><span class="section-number">11.2.2. </span>File copy performance<a class="headerlink" href="#file-copy-performance" title="Permalink to this headline">¶</a></h3>
<p><code class="code docutils literal notranslate"><span class="pre">ch-image</span></code> does a lot of file copying. The bulk of this is manipulating
images in the storage directory. Importantly, this includes <a class="reference internal" href="ch-image.html#ch-image-bu-large"><span class="std std-ref">large files</span></a> stored by the build cache outside its Git repository,
though this feature is disabled by default.</p>
<p>Copies are costly both in time (to read, transfer, and write the duplicate
bytes) and space (to store the bytes). However significant optimizations are
sometimes available. Charliecloud’s internal file copies (unfortunately not
sub-programs like Git) can take advantage of multiple optimized file-copy
paths offered by Linux:</p>
<dl class="simple">
<dt>in-kernel copy</dt><dd><p>Copy data inside the kernel without passing through user-space. Saves time
but not space.</p>
</dd>
<dt>server-side copy</dt><dd><p>Copy data on the server without sending it over the network, relevant only
for network filesystems. Saves time but not space.</p>
</dd>
<dt>reflink copy (best)</dt><dd><p>Copy-on-write via “<a class="reference external" href="https://blog.ram.rachum.com/post/620335081764077568/symlinks-and-hardlinks-move-over-make-room-for">reflink</a>”.
The destination file gets a new inode but shares the data extents of the
source file — i.e., no data are copied! — with extents unshared later
if/when are written. Saves both time and space (and potentially quite a
lot).</p>
</dd>
</dl>
<p>To use these optimizations, you need:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Python ≥3.8, for <code class="code docutils literal notranslate"><span class="pre">os.copy_file_range()</span></code> (<a class="reference external" href="https://docs.python.org/3/library/os.html#os.copy_file_range">docs</a>), which
wraps <code class="code docutils literal notranslate"><span class="pre">copy_file_range(2)</span></code> (<a class="reference external" href="https://man7.org/linux/man-pages/man2/copy_file_range.2.html">man page</a>), which
selects the best method from the three above.</p></li>
<li><p>A new-ish Linux kernel (details vary).</p></li>
<li><p>The right filesystem.</p></li>
</ol>
</div></blockquote>
<p>The following table summarizes our (possibly incorrect) understanding of
filesystem support as of October 2023. For current or historical information,
see the <a class="reference external" href="https://elixir.bootlin.com/linux/latest/A/ident/remap_file_range">Linux source code</a> for
in-kernel filesystems or specific filesystem release nodes, e.g. <a class="reference external" href="https://github.com/openzfs/zfs/releases">ZFS</a>. A checkmark ✅ indicates
supported, ❌ unsupported. We recommend using a filesystem that supports
reflink and also (if applicable) server-side copy.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 38%" />
<col style="width: 20%" />
<col style="width: 20%" />
<col style="width: 22%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"><p>in-kernel</p></th>
<th class="head"><p>server-side</p></th>
<th class="head"><p>reflink (best)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td colspan="4"><p><em>local filesystems</em></p></td>
</tr>
<tr class="row-odd"><td><p>BTRFS</p></td>
<td><p>✅</p></td>
<td><p>n/a</p></td>
<td><p>✅</p></td>
</tr>
<tr class="row-even"><td><p>OCFS2</p></td>
<td><p>✅</p></td>
<td><p>n/a</p></td>
<td><p>✅</p></td>
</tr>
<tr class="row-odd"><td><p>XFS</p></td>
<td><p>✅</p></td>
<td><p>n/a</p></td>
<td><p>✅</p></td>
</tr>
<tr class="row-even"><td><p>ZFS</p></td>
<td><p>✅</p></td>
<td><p>n/a</p></td>
<td><p>✅ [1]</p></td>
</tr>
<tr class="row-odd"><td colspan="4"><p><em>network filesystems</em></p></td>
</tr>
<tr class="row-even"><td><p>CIFS/SMB</p></td>
<td><p>✅</p></td>
<td><p>✅</p></td>
<td><p>?</p></td>
</tr>
<tr class="row-odd"><td><p>NFSv3</p></td>
<td><p>✅</p></td>
<td><p>❌</p></td>
<td><p>❌</p></td>
</tr>
<tr class="row-even"><td><p>NFSv4</p></td>
<td><p>✅</p></td>
<td><p>✅</p></td>
<td><p>✅ [2]</p></td>
</tr>
<tr class="row-odd"><td colspan="4"><p><em>other situations</em></p></td>
</tr>
<tr class="row-even"><td><p>filesystems not listed</p></td>
<td><p>✅</p></td>
<td><p>❌</p></td>
<td><p>❌</p></td>
</tr>
<tr class="row-odd"><td><p>copies between filesystems</p></td>
<td><p>❌ [3]</p></td>
<td><p>❌</p></td>
<td><p>❌</p></td>
</tr>
</tbody>
</table>
<p>Notes:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>As of <a class="reference external" href="https://github.com/openzfs/zfs/releases/tag/zfs-2.2.0">ZFS 2.2.0</a>.</p></li>
<li><p>If the underlying exported filesystem also supports reflink.</p></li>
<li><p>Recent kernels (≥5.18 as well as stable kernels if backported) support
in-kernel file copy between filesystems, but for many kernels it is <a class="reference external" href="https://man7.org/linux/man-pages/man2/copy_file_range.2.html#BUGS">not
stable</a>, so
Charliecloud does not currently attempt it.</p></li>
</ol>
</div></blockquote>
</section>
</section>
<section id="installing-your-own-software">
<h2><span class="section-number">11.3. </span>Installing your own software<a class="headerlink" href="#installing-your-own-software" title="Permalink to this headline">¶</a></h2>
<p>This section covers four situations for making software available inside a
Charliecloud container:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Third-party software installed into the image using a package manager.</p></li>
<li><p>Third-party software compiled from source into the image.</p></li>
<li><p>Your software installed into the image.</p></li>
<li><p>Your software stored on the host but compiled in the container.</p></li>
</ol>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Maybe you don’t have to install the software at all. Is there already a
trustworthy image on Docker Hub you can use as a base?</p>
</div>
<section id="third-party-software-via-package-manager">
<h3><span class="section-number">11.3.1. </span>Third-party software via package manager<a class="headerlink" href="#third-party-software-via-package-manager" title="Permalink to this headline">¶</a></h3>
<p>This approach is the simplest and fastest way to install stuff in your image.
The <code class="code docutils literal notranslate"><span class="pre">examples/hello</span></code> Dockerfile does this to install the package
<code class="code docutils literal notranslate"><span class="pre">openssh-client</span></code>:</p>
<div class="highlight-docker notranslate"><div class="highlight"><pre><span></span><span class="k">RUN</span> dnf install -y --setopt<span class="o">=</span><span class="nv">install_weak_deps</span><span class="o">=</span><span class="nb">false</span> openssh-clients <span class="se">\</span>
 <span class="o">&amp;&amp;</span> dnf clean all

<span class="k">COPY</span> . hello
</pre></div>
</div>
<p>You can use distribution package managers such as <code class="code docutils literal notranslate"><span class="pre">dnf</span></code>, as demonstrated
above, or others, such as <code class="code docutils literal notranslate"><span class="pre">pip</span></code> for Python packages. Be aware that the
software will be downloaded anew each time you execute the instruction (unless
you add an HTTP cache, which is out of scope of this documentation).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>RPM and friends (<code class="code docutils literal notranslate"><span class="pre">yum</span></code>, <code class="code docutils literal notranslate"><span class="pre">dnf</span></code>, etc.) have traditionally been
rather troublesome in containers, and we suspect there are bugs we haven’t
ironed out yet. If you encounter problems, please do file a bug!</p>
</div>
</section>
<section id="third-party-software-compiled-from-source">
<h3><span class="section-number">11.3.2. </span>Third-party software compiled from source<a class="headerlink" href="#third-party-software-compiled-from-source" title="Permalink to this headline">¶</a></h3>
<p>Under this method, one uses <code class="code docutils literal notranslate"><span class="pre">RUN</span></code> commands to fetch the desired software
using <code class="code docutils literal notranslate"><span class="pre">curl</span></code> or <code class="code docutils literal notranslate"><span class="pre">wget</span></code>, compile it, and install. Our example does
this with two chained Dockerfiles. First, we build a basic AlmaLinux image
(<code class="code docutils literal notranslate"><span class="pre">examples/Dockerfile.almalinux_8ch</span></code>):</p>
<blockquote>
<div><div class="highlight-docker notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span> <span class="s">almalinux:8</span>

<span class="c"># This image has three purposes: (1) demonstrate we can build a AlmaLinux 8</span>
<span class="c"># image, (2) provide a build environment for Charliecloud EPEL 8 RPMs, and (3)</span>
<span class="c"># provide image packages necessary for Obspy and Paraview.</span>
<span class="c">#</span>
<span class="c"># Quirks:</span>
<span class="c">#</span>
<span class="c">#   1. Install the dnf ovl plugin to work around RPMDB corruption when</span>
<span class="c">#      building images with Docker and the OverlayFS storage driver.</span>
<span class="c">#</span>
<span class="c">#   2. Enable PowerTools repo, because some packages in EPEL depend on it.</span>
<span class="c">#</span>
<span class="c">#   3. Install packages needed to build el8 rpms.</span>
<span class="c">#</span>
<span class="c">#   4. Issue #1103: Install libarchive to resolve cmake bug</span>
<span class="c">#</span>
<span class="c"># FIXME: This instruction seems to be running afoul of #1679. I’ve re-wrapped</span>
<span class="c"># it to have fewer continuations in hopes we trigger that less.</span>
<span class="k">RUN</span> dnf install -y --setopt<span class="o">=</span><span class="nv">install_weak_deps</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
                epel-release <span class="se">\</span>
                <span class="s1">&#39;dnf-command(config-manager)&#39;</span> <span class="se">\</span>
 <span class="o">&amp;&amp;</span> dnf config-manager --enable powertools <span class="se">\</span>
 <span class="o">&amp;&amp;</span> dnf install -y --setopt<span class="o">=</span><span class="nv">install_weak_deps</span><span class="o">=</span><span class="nb">false</span> <span class="se">\</span>
                dnf-plugin-ovl <span class="se">\</span>
                autoconf automake gcc git libarchive libpng-devel make python3 python3-devel python3-lark-parser python3-requests python3-sphinx python3-sphinx_rtd_theme rpm-build rpmlint rsync squashfs-tools squashfuse wget which <span class="se">\</span>
 <span class="o">&amp;&amp;</span> dnf clean all

<span class="c"># Need wheel to install bundled Lark, and the RPM version doesn’t work.</span>
<span class="k">RUN</span> pip3 install wheel

<span class="c"># AlmaLinux&#39;s linker doesn’t search these paths by default; add them because we</span>
<span class="c"># will install stuff later into /usr/local.</span>
<span class="k">RUN</span> <span class="nb">echo</span> <span class="s2">&quot;/usr/local/lib&quot;</span> &gt; /etc/ld.so.conf.d/usrlocal.conf <span class="se">\</span>
 <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;/usr/local/lib64&quot;</span> &gt;&gt; /etc/ld.so.conf.d/usrlocal.conf <span class="se">\</span>
 <span class="o">&amp;&amp;</span> ldconfig

<span class="c"># Install ImageMagick</span>
<span class="c"># The latest, 7.1.0, fails to install with a cryptic libtool error. ¯\_(ツ)_/¯</span>
<span class="k">ARG</span> <span class="nv">MAGICK_VERSION</span><span class="o">=</span><span class="m">7</span>.0.11-14
<span class="k">RUN</span> wget -nv -O ImageMagick-<span class="si">${</span><span class="nv">MAGICK_VERSION</span><span class="si">}</span>.tar.gz <span class="se">\</span>
    <span class="s2">&quot;https://github.com/ImageMagick/ImageMagick/archive/refs/tags/</span><span class="si">${</span><span class="nv">MAGICK_VERSION</span><span class="si">}</span><span class="s2">.tar.gz&quot;</span> <span class="se">\</span>
 <span class="o">&amp;&amp;</span> tar xf ImageMagick-<span class="si">${</span><span class="nv">MAGICK_VERSION</span><span class="si">}</span>.tar.gz <span class="se">\</span>
 <span class="o">&amp;&amp;</span> <span class="nb">cd</span> ImageMagick-<span class="si">${</span><span class="nv">MAGICK_VERSION</span><span class="si">}</span> <span class="se">\</span>
 <span class="o">&amp;&amp;</span> ./configure --prefix<span class="o">=</span>/usr/local <span class="se">\</span>
 <span class="o">&amp;&amp;</span> make -j <span class="k">$(</span>getconf _NPROCESSORS_ONLN<span class="k">)</span> install <span class="se">\</span>
 <span class="o">&amp;&amp;</span> rm -Rf ../ImageMagick-<span class="si">${</span><span class="nv">MAGICK_VERSION</span><span class="si">}</span>

<span class="c"># Add mount points for files and directories for paraview and obspy comparison</span>
<span class="c"># tests.</span>
<span class="k">RUN</span> mkdir /diff <span class="se">\</span>
 <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;example bind mount file&quot;</span> &gt; /a.png <span class="se">\</span>
 <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;example bind mount file&quot;</span> &gt; /b.png
</pre></div>
</div>
</div></blockquote>
<p>Then, in a second image (<code class="code docutils literal notranslate"><span class="pre">examples/Dockerfile.openmpi</span></code>), we add OpenMPI.
This is a complex Dockerfile that compiles several dependencies in addition to
OpenMPI. For the purposes of this documentation, you can skip most of it, but
we felt it would be useful to show a real example.</p>
<div class="highlight-docker notranslate"><div class="highlight"><pre><span></span><span class="k">FROM</span> <span class="s">libfabric</span>

<span class="c"># See Dockerfile.libfabric for MPI goals and details.</span>

<span class="c"># OpenMPI.</span>
<span class="c">#</span>
<span class="c"># Build with PMIx, PMI2, and FLUX-PMI support.</span>
<span class="c">#</span>
<span class="c">#   1. --disable-pty-support to avoid “pipe function call failed when</span>
<span class="c">#      setting up I/O forwarding subsystem”.</span>
<span class="c">#</span>
<span class="c">#   2. --enable-mca-no-build=plm-slurm to support launching processes using the</span>
<span class="c">#     host’s srun (i.e., the container OpenMPI needs to talk to the host Slurm’s</span>
<span class="c">#     PMIx) but prevent OpenMPI from invoking srun itself from within the</span>
<span class="c">#     container, where srun is not installed (the error messages from this are</span>
<span class="c">#     inscrutable).</span>
<span class="k">ARG</span> <span class="nv">MPI_URL</span><span class="o">=</span>https://www.open-mpi.org/software/ompi/v4.1/downloads
<span class="k">ARG</span> <span class="nv">MPI_VERSION</span><span class="o">=</span><span class="m">4</span>.1.4
<span class="k">RUN</span> wget -nv <span class="si">${</span><span class="nv">MPI_URL</span><span class="si">}</span>/openmpi-<span class="si">${</span><span class="nv">MPI_VERSION</span><span class="si">}</span>.tar.gz <span class="se">\</span>
 <span class="o">&amp;&amp;</span> tar xf openmpi-<span class="si">${</span><span class="nv">MPI_VERSION</span><span class="si">}</span>.tar.gz
<span class="k">RUN</span> <span class="nb">cd</span> openmpi-<span class="si">${</span><span class="nv">MPI_VERSION</span><span class="si">}</span> <span class="se">\</span>
 <span class="o">&amp;&amp;</span> <span class="nv">CFLAGS</span><span class="o">=</span>-O3 <span class="se">\</span>
    <span class="nv">CXXFLAGS</span><span class="o">=</span>-O3 <span class="se">\</span>
    <span class="nv">FLUX_PMI_CFLAGS</span><span class="o">=</span>-I/usr/local/include/flux/core,-L/usr/local/lib/flux <span class="se">\</span>
    <span class="nv">FLUX_PMI_LIBS</span><span class="o">=</span>-lpmi <span class="se">\</span>
    ./configure --prefix<span class="o">=</span>/usr/local <span class="se">\</span>
                --sysconfdir<span class="o">=</span>/mnt/0 <span class="se">\</span>
                --with-pmix<span class="o">=</span>/usr/local <span class="se">\</span>
                --with-pmi<span class="o">=</span>/usr/local <span class="se">\</span>
                --with-flux-pmi-library <span class="se">\</span>
                --with-libfabric<span class="o">=</span>/usr/local <span class="se">\</span>
                --disable-pty-support <span class="se">\</span>
                --enable-mca-no-build<span class="o">=</span>btl-openib,plm-slurm <span class="se">\</span>
 <span class="o">&amp;&amp;</span> make -j<span class="k">$(</span>getconf _NPROCESSORS_ONLN<span class="k">)</span> install <span class="se">\</span>
 <span class="o">&amp;&amp;</span> rm -Rf ../openmpi-<span class="si">${</span><span class="nv">MPI_VERSION</span><span class="si">}</span>*
<span class="k">RUN</span> ldconfig

<span class="c"># OpenMPI expects this program to exist, even if it’s not used. Default is</span>
<span class="c"># “ssh : rsh”, but that’s not installed.</span>
<span class="k">RUN</span> <span class="nb">echo</span> <span class="s1">&#39;plm_rsh_agent = false&#39;</span> &gt;&gt; /mnt/0/openmpi-mca-params.conf

<span class="c"># Silence spurious pmix error. https://github.com/open-mpi/ompi/issues/7516.</span>
<span class="k">ENV</span> <span class="nv">PMIX_MCA_gds</span><span class="o">=</span><span class="nb">hash</span>
</pre></div>
</div>
<p>So what is going on here?</p>
<ol class="arabic simple">
<li><p>Use the latest AlmaLinux 8 as the base image.</p></li>
<li><p>Install a basic build system using the OS package manager.</p></li>
<li><p>For a few dependencies and then OpenMPI itself:</p>
<ol class="arabic simple">
<li><p>Download and untar. Note the use of variables to make adjusting the URL
and versions easier, as well as the explanation of why we’re not using
<code class="code docutils literal notranslate"><span class="pre">dnf</span></code>, given that several of these packages are included in
CentOS.</p></li>
<li><p>Build and install OpenMPI. Note the <code class="code docutils literal notranslate"><span class="pre">getconf</span></code> trick to guess at an
appropriate parallel build.</p></li>
</ol>
</li>
<li><p>Clean up, in order to reduce the size of the build cache as well as the
resulting Charliecloud image (<code class="code docutils literal notranslate"><span class="pre">rm</span> <span class="pre">-Rf</span></code>).</p></li>
</ol>
</section>
<section id="your-software-stored-in-the-image">
<h3><span class="section-number">11.3.3. </span>Your software stored in the image<a class="headerlink" href="#your-software-stored-in-the-image" title="Permalink to this headline">¶</a></h3>
<p>This method covers software provided by you that is included in the image.
This is recommended when your software is relatively stable or is not easily
available to users of your image, for example a library rather than simulation
code under active development.</p>
<p>The general approach is the same as installing third-party software from
source, but you use the <code class="code docutils literal notranslate"><span class="pre">COPY</span></code> instruction to transfer files from the
host filesystem (rather than the network via HTTP) to the image. For example,
<code class="code docutils literal notranslate"><span class="pre">examples/mpihello/Dockerfile.openmpi</span></code> uses this approach:</p>
<div class="highlight-docker notranslate"><div class="highlight"><pre><span></span><span class="c"># ch-test-scope: full</span>
<span class="k">FROM</span> <span class="s">openmpi</span>

<span class="c"># This example</span>
<span class="k">COPY</span> . /hello
<span class="k">WORKDIR</span><span class="s"> /hello</span>
<span class="k">RUN</span> make clean <span class="o">&amp;&amp;</span> make
</pre></div>
</div>
<p>These Dockerfile instructions:</p>
<ol class="arabic">
<li><p>Copy the host directory <code class="code docutils literal notranslate"><span class="pre">examples/mpihello</span></code> to the image at path
<code class="code docutils literal notranslate"><span class="pre">/hello</span></code>. The host path is relative to the <em>context directory</em>, which
is tarred up and sent to the Docker daemon. Docker builds have no access to
the host filesystem outside the context directory.</p>
<p>(Unlike HPC, Docker comes from a world without network filesystems. This
tar-based approach lets the Docker daemon run on a different node from the
client without needing any shared filesystems.)</p>
<p>The usual convention, including for Charliecloud tests and examples, is
that the context is the directory containing the Dockerfile in question. A
common pattern, used here, is to copy in the entire context.</p>
</li>
<li><p><code class="code docutils literal notranslate"><span class="pre">cd</span></code> to <code class="code docutils literal notranslate"><span class="pre">/hello</span></code>.</p></li>
<li><p>Compile our example. We include <code class="code docutils literal notranslate"><span class="pre">make</span> <span class="pre">clean</span></code> to remove any leftover
build files, since they would be inappropriate inside the container.</p></li>
</ol>
<p>Once the image is built, we can see the results. (Install the image into
<code class="code docutils literal notranslate"><span class="pre">/var/tmp</span></code> as outlined in the tutorial, if you haven’t already.)</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> ch-run /var/tmp/mpihello-openmpi.sqfs -- ls -lh /hello
<span class="go">total 32K</span>
<span class="go">-rw-rw---- 1 charlie charlie  908 Oct  4 15:52 Dockerfile</span>
<span class="go">-rw-rw---- 1 charlie charlie  157 Aug  5 22:37 Makefile</span>
<span class="go">-rw-rw---- 1 charlie charlie 1.2K Aug  5 22:37 README</span>
<span class="go">-rwxr-x--- 1 charlie charlie 9.5K Oct  4 15:58 hello</span>
<span class="go">-rw-rw---- 1 charlie charlie 1.4K Aug  5 22:37 hello.c</span>
<span class="go">-rwxrwx--- 1 charlie charlie  441 Aug  5 22:37 test.sh</span>
</pre></div>
</div>
</section>
<section id="your-software-stored-on-the-host">
<h3><span class="section-number">11.3.4. </span>Your software stored on the host<a class="headerlink" href="#your-software-stored-on-the-host" title="Permalink to this headline">¶</a></h3>
<p>This method leaves your software on the host but compiles it in the image.
This is recommended when your software is volatile or each image user needs a
different version, for example a simulation code under active development.</p>
<p>The general approach is to bind-mount the appropriate directory and then run
the build inside the container. We can re-use the <code class="code docutils literal notranslate"><span class="pre">mpihello</span></code> image to
demonstrate this.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">cd</span> examples/mpihello
<span class="gp">$</span> ls -l
<span class="go">total 20</span>
<span class="go">-rw-rw---- 1 charlie charlie  908 Oct  4 09:52 Dockerfile</span>
<span class="go">-rw-rw---- 1 charlie charlie 1431 Aug  5 16:37 hello.c</span>
<span class="go">-rw-rw---- 1 charlie charlie  157 Aug  5 16:37 Makefile</span>
<span class="go">-rw-rw---- 1 charlie charlie 1172 Aug  5 16:37 README</span>
<span class="gp">$</span> ch-run -b .:/mnt/0 --cd /mnt/0 /var/tmp/mpihello.sqfs -- <span class="se">\</span>
  make mpicc -std<span class="o">=</span>gnu11 -Wall hello.c -o hello
<span class="gp">$</span> ls -l
<span class="go">total 32</span>
<span class="go">-rw-rw---- 1 charlie charlie  908 Oct  4 09:52 Dockerfile</span>
<span class="go">-rwxrwx--- 1 charlie charlie 9632 Oct  4 10:43 hello</span>
<span class="go">-rw-rw---- 1 charlie charlie 1431 Aug  5 16:37 hello.c</span>
<span class="go">-rw-rw---- 1 charlie charlie  157 Aug  5 16:37 Makefile</span>
<span class="go">-rw-rw---- 1 charlie charlie 1172 Aug  5 16:37 README</span>
</pre></div>
</div>
<p>A common use case is to leave a container shell open in one terminal for
building, and then run using a separate container invoked from a different
terminal.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="faq.html" class="btn btn-neutral float-left" title="10. Frequently asked questions (FAQ)" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="dev.html" class="btn btn-neutral float-right" title="12. Contributor’s guide" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2014–2023, Triad National Security, LLC and others.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>